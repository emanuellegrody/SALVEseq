---
title: "EGS013SALVEseq"
author: "Emanuelle Grody"
date: "2025-03-17"
output: html_document
---

```{r, echo = FALSE}
source("~/SALVEseq/packages.R")
source("~/SALVEseq/functions.R")
```

## GEX

Outputting expression matrix
```{r}
#v3
# Pacute <- SeuratPipeline("/projects/b1042/GoyalLab/egrody/extractedData/EGS009/singleCell/counts/Mmul_10_mac239/Mmul_10_mac239_P_acute_GEX/outs/filtered_feature_bc_matrix/", "Pacute", plots = FALSE)
# 
# output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS009/singleCell/counts/Mmul_10_mac239/expressionDF/"
# SingleCell_Pacute <- targetExpressionDF(Pacute, "mac239", count_type = "raw")
# write.csv(SingleCell_Pacute, paste0(output.dir, "Pacute_Mmulmac_mac239.csv"))

#v4
Pacute <- SeuratPipeline("/projects/b1042/GoyalLab/egrody/extractedData/EGS013/singleCell/counts/Mmul_10_mac239v4_P_acute_GEX/outs/filtered_feature_bc_matrix/", "Pacute", plots = FALSE)

genes <- c(
  "D1-US",
  "D1-S",
  "tat-US",
  "tat-S",
  "nef-3",
  "nef-5",
  "LTR-3",
  "LTR-5"
)

output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/singleCell/counts/expressionDF/"
SingleCell_Pacute <- targetExpressionDF(Pacute, genes, count_type = "raw")
write.csv(SingleCell_Pacute, paste0(output.dir, "Pacute_Mmulmacv4.csv"))

## updating UMAP coordinates to without viral reads
output_dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS009/singleCell/counts/Mmul_10/expressionDF/"
Mmul_only_coords <-  SeuratPipeline("/projects/b1042/GoyalLab/egrody/extractedData/EGS009/singleCell/counts/Mmul_10/Mmul_10_P_acute_GEX/outs/filtered_feature_bc_matrix/", "Pacute", plots = FALSE)
Mmul_only <- targetExpressionDF(Mmul_only_coords, "CD4")
Mmul_only <- Mmul_only %>% select(-CD4)
write.csv(Mmul_only, paste0(output_dir, "Pacute_Mmul.csv"))

SingleCell_Pacute <- SingleCell_Pacute %>%
  select(-X, -UMAP1, -UMAP2, -cluster)
SingleCell_Pacute <- left_join(SingleCell_Pacute, Mmul_only, by = "cellID")
SingleCell_Pacute$sample <- "Pacute"
GEX_isoforms <- isoforms_deconvolve(SingleCell_Pacute, "GEX")
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/singleCell/counts/expressionDF/"
write.csv(GEX_isoforms, paste0(output.dir, "Pacute_isoforms.csv"))
```


## SALVE

### bamsort
```{r}
input.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/bamsort/xf25"

# Get all files from "Pacute"
pacute_files <- list.files(input.dir, pattern = "Pacute_bamsort_.*\\.csv$", full.names = TRUE)
pacute_data_list <- list()

for (file in pacute_files) {
  file_name <- sub(".*Pacute_bamsort_(.*)\\.csv$", "\\1", basename(file))
  pacute_data_list[[file_name]] <- read.csv(file)
  #cat("Loaded:", file_name, "\n")
}

# Combine nefs and LTRs
pacute_data_list[["nef"]] <- rbind(
  pacute_data_list[["nef_3"]],
  pacute_data_list[["nef_5"]]
)

pacute_data_list[["nef"]] <- unique(pacute_data_list[["nef"]])

pacute_data_list[["nef_3"]] <- NULL
pacute_data_list[["nef_5"]] <- NULL
pacute_data_list[["LTR"]] <- rbind(
  pacute_data_list[["LTR_3"]],
  pacute_data_list[["LTR_5"]]
)

pacute_data_list[["LTR"]] <- unique(pacute_data_list[["LTR"]])

pacute_data_list[["LTR_3"]] <- NULL
pacute_data_list[["LTR_5"]] <- NULL

pacute_data_list[["absolute"]] <- anti_join(
  pacute_data_list[["LTR"]],
  pacute_data_list[["nef"]],
  by = c("cellID", "UMI")
)

cat(
  "Number of unique molecules total: \t",
  nrow(pacute_data_list[["absolute"]]),
  "\nNumber of vRNA+ cells from absolute: \t",
  length(unique(pacute_data_list[["absolute"]]$cellID)),
  "\nNumber of vRNA+ cells from all: \t",
  length(unique(c(
  pacute_data_list[["absolute"]]$cellID,
  pacute_data_list[["D1_S"]]$cellID,
  pacute_data_list[["D1_US"]]$cellID,
  pacute_data_list[["tat_S"]]$cellID,
  pacute_data_list[["tat_US"]]$cellID
  )))
)
```

Now making counts
```{r}
combined_umi_counts <- NULL

# Process each dataframe
for (name in names(pacute_data_list)) {
  # Get the current dataframe
  df <- pacute_data_list[[name]]
  
  # Count UMIs per cell
  count_df <- df %>%
    group_by(cellID) %>%
    summarize(Count = n_distinct(UMI), .groups = "drop") %>%
    rename(!!paste0(name) := Count)
  
  # Merge with the combined table
  if (is.null(combined_umi_counts)) {
    combined_umi_counts <- count_df
  } else {
    combined_umi_counts <- full_join(combined_umi_counts, count_df, by = "cellID")
  }
  remove(df, count_df)
}

# Replace NA values with 0 (cells not present in some datasets)
combined_umi_counts[is.na(combined_umi_counts)] <- 0

Pacute_SALVE <- combined_umi_counts %>%
  mutate(total_lessLTR = rowSums(across(c("D1_S", "D1_US", "tat_S", "tat_US", "nef")))) %>%
  select(-nef, -LTR) %>%
  filter(absolute > 0) %>%
  filter(total_lessLTR > 2) %>%
  mutate(across(where(is.numeric), log1p)) #log1p transform

output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/bamsort/"
write.csv(combined_umi_counts, paste0(output.dir, "Pacute_SALVE_full.csv"))
write.csv(Pacute_SALVE, paste0(output.dir, "Pacute_SALVE_filtered.csv"))

```

Experimenting, skip:
```{r}
# Deeper dive
Pacute_SALVE <- combined_umi_counts %>%
  mutate(total_lessLTR = rowSums(across(c("D1_S", "D1_US", "tat_S", "tat_US", "nef")))) %>%
  mutate(total_D1tat = rowSums(across(c("D1_S", "D1_US", "tat_S", "tat_US"))))

cat(
  "Correlation between absolute and total_lessLTR:\n",
    "  Pearson: ", round(cor(Pacute_SALVE$absolute, Pacute_SALVE$total_lessLTR, method="pearson"), 3),
    "\n  Spearman: ", round(cor(Pacute_SALVE$absolute, Pacute_SALVE$total_lessLTR, method="spearman"), 3),
    
    "\n\nCorrelation between absolute and total_D1tat:\n",
    "  Pearson: ", round(cor(Pacute_SALVE$absolute, Pacute_SALVE$total_D1tat, method="pearson"), 3),
    "\n  Spearman: ", round(cor(Pacute_SALVE$absolute, Pacute_SALVE$total_D1tat, method="spearman"), 3)
)

# plotting
plot <- ggplot(data = Pacute_SALVE, aes(x = absolute, y = total_lessLTR)) +
      geom_point() +
      labs(
        x = "Absolute (5' LTR) counts",
        y = "Total counts: D1 + tat + nef",
        title = "Pacute SALVE bamsort") +
      theme_minimal() + 
    coord_fixed(ratio = 1)
plot <- ggplot(data = Pacute_SALVE, aes(x = absolute, y = total_D1tat)) +
      geom_point() +
      labs(
        x = "Absolute (5' LTR) counts",
        y = "Total counts: D1 + tat",
        title = "Pacute SALVE bamsort") +
      theme_minimal() +
    coord_fixed(ratio = 1)
plot + theme(aspect.ratio = 1)

#playing around with filtering
Pacute_SALVE <- Pacute_SALVE %>%
  select(-nef, -LTR) %>%
  filter(total_lessLTR > 2) %>%
  filter(absolute > 0) 
```


### Seurat
```{r process}
genes <- c(
  "D1-US",
  "D1-S",
  "tat-US",
  "tat-S",
  "nef-3",
  "nef-5",
  "LTR-3",
  "LTR-5"
)
# Initialize empty list
SALVE_list <- list()

sample_name <- "Pacute"
targets <- c("D1_up_PL", "nef_PL", "LTR_PL", "tat_up_PL")

for (k in 1:length(targets)) {
  target_name <- targets[k]
  folder_path <- paste0("/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/counts/concat/Mmul_10_mac239v4_", 
                        sample_name, "_", target_name, "/outs/raw_feature_bc_matrix/")
  
  tryCatch({
    # Process the current sample
    data <- Read10X(data.dir = folder_path)
    seurat_obj <- CreateSeuratObject(counts = data, project = sample_name, min.cells = 3)
    #seurat_obj <- NormalizeData(seurat_obj, verbose = FALSE) #for raw, comment this out
    # Extract viral genes
    sample_df <- targetExpressionDF(seurat_obj, genes, count_type = "raw") #genes
    
    # Add sample and target columns to the dataframe
    sample_df$sample <- sample_name
    sample_df$target <- target_name
    
    # Add to list
    SALVE_list[[length(SALVE_list) + 1]] <- sample_df
    
    cat("Processed sample:", sample_name, "with target:", target_name, "\n")
    
  }, error = function(e) {
    cat("Error processing sample", sample_name, "with target", target_name, ":", conditionMessage(e), "\n\n")
  })
}

SALVE_combined <- data.frame()
SALVE_combined <- bind_rows(SALVE_list)
SALVE_combined <- SALVE_combined %>%
  filter(!(`D1-US` == 0 & 
             `D1-S` == 0 & 
             `tat-US` == 0 &
             `tat-S` == 0 &
             `nef-3` == 0 & 
             `nef-5` == 0 & 
             `LTR-3` == 0 & 
             `LTR-5` == 0))
rm(SALVE_list)

output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/counts/concat/expressionDF/"
write.csv(SALVE_combined, paste0(output.dir, "SALVE_combined_Mmulmacv4_rawcounts.csv"))

output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS014/SALVE/counts/expressionDF/"
SALVE_combined <- read.csv(paste0(output.dir, "SALVE_combined_Mmulmacv4_rawcounts.csv"))
```

Calculating isoforms
```{r}
SALVE_isoforms <- isoforms_deconvolve(SALVE_combined, "SALVE")
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/counts/concat/expressionDF/"
write.csv(SALVE_isoforms, paste0(output.dir, "SALVE_isoforms_Mmulmacv4_rawcounts.csv"))

SALVE_isoforms <- read.csv(paste0(output.dir, "SALVE_isoforms_Mmulmacv4_rawcounts.csv"))
```

## KLRB1

GEX: making expressionDF
```{r GEX}
# making expressionDF
samples <- data.frame(
  samples = c(
    "P_acute_GEX",
    "W0"
  ),
  folders = c(
    "/projects/b1042/GoyalLab/egrody/extractedData/EGS009/singleCell/counts/Mmul_10_mac239/",
    "/projects/b1042/GoyalLab/egrody/extractedData/EGS002/singleCell/counts/Mmul_10_mac239/"
  )
)

# Process each sample
for (i in 1:nrow(samples)) {
  sample_name <- samples$samples[i]
  folder_path <- samples$folders[i]
  
  input.dir <- paste0(folder_path, "Mmul_10_mac239_", sample_name, "/outs/filtered_feature_bc_matrix/")
  
  cat("Reading from:", input.dir, "\n")
  
  tryCatch({
    # Process the current sample
    seurat_obj <- SeuratPipeline(input.dir, sample_name, plots = FALSE)
    
    # Generate the target expression data frame
    singlecell_df <- targetExpressionDF(seurat_obj, "KLRB1")
    
    # Create expressionDF directory if it doesn't exist
    output_dir <- paste0(folder_path, "expressionDF/")
    dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)
    
    # Write the CSV
    output_filename <- paste0(output_dir, sample_name, "_KLRB1.csv")
    write.csv(singlecell_df, output_filename)
    
    cat("Processed sample:", sample_name, "\n")
    cat("Saved to:", output_filename, "\n\n")
  }, error = function(e) {
    cat("Error processing sample", sample_name, ":", conditionMessage(e), "\n\n")
  })
}
```
SALVE
### bamsort and minimums
```{r SALVE}
samples <- data.frame(
  datasets = c(
    "P_acute_GEX",
    "W0"
  ),
  samples = c(
    "Pacute",
    "Uninfected"
  ),
  folders = c(
    "/projects/b1042/GoyalLab/egrody/extractedData/EGS009/singleCell/counts/Mmul_10_mac239/",
    "/projects/b1042/GoyalLab/egrody/extractedData/EGS002/singleCell/counts/Mmul_10_mac239/"
  )
)

input.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/bamsort/alignment/KLRB1"
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/bamsort/reads/KLRB1"

raw_cellIDs_df <- read.csv("/projects/b1042/GoyalLab/egrody/extractedData/EGS014/singleCell/raw_cellIDs/all_raw_cellIDs.csv")
raw_cellIDs <- split(raw_cellIDs_df$cellID, raw_cellIDs_df$sample)

# processing
#process_bamsort("SALVE", samples$samples, input.dir, output.dir, raw_cellIDs)

for (i in 1:nrow(samples)) {
  sample <- samples$samples[i]
  cat("\nProcessing sample:", sample, "\n")
  
  # Get all files for current sample
  sample_files <- list.files(input.dir, 
                             pattern = paste0(samples$datasets[i], "_bamsort_alignment_KLRB1.csv"), 
                             full.names = TRUE)
  
  # Create a data frame to store the combined results
  all_data <- data.frame()
  filenames <- basename(sample_files)
  
  # Process each relevant file
  for (j in seq_along(sample_files)) {
    extracted_data <- NULL  # Initialize as NULL for each file
    
    tryCatch({
      # Read the CSV file, expecting standard column names
      file_data <- fread(sample_files[j], data.table = FALSE)
      
      # Check if file has content
      if(nrow(file_data) == 0) {
        cat("Warning: File is empty:", filenames[j], "\n")
        next
      }
      
      # Simplify column mapping - expect standard column names
      required_cols <- c("cellID", "UMI", "count")
      
      # Check if all required columns exist
      missing_cols <- setdiff(required_cols, colnames(file_data))
      
      if (length(missing_cols) > 0) {
        cat("Warning: Missing required columns:", paste(missing_cols, collapse=", "), "\n")
        cat("Available columns:", paste(colnames(file_data), collapse=", "), "\n")
        next
      }
      
      # Extract data with the required columns and add category
      extracted_data <- file_data %>%
        select(cellID, UMI, count) %>%
        rename(read = count) %>%  # Rename count to read for consistency with later code
        mutate(category = "KLRB1")
      
    }, error = function(e) {
      cat("Error reading file:", filenames[j], "\nLikely bad data file\n")
      cat("Error message:", conditionMessage(e), "\n")
    })
    
    # Add to the combined data frame only if we have data
    if (!is.null(extracted_data) && nrow(extracted_data) > 0) {
      all_data <- rbind(all_data, extracted_data)
    }
    # Remove any rows with NA values and unique
    all_data <- all_data %>% 
      filter(!is.na(cellID) & !is.na(UMI) & !is.na(read)) %>%
      unique()
    
    # Count reads per UMI
    tryCatch({
      umi_read_counts <- all_data %>%
        group_by(cellID, UMI, category) %>%
        summarize(
          read_count = sum(as.numeric(read)),  # Sum the count values
          .groups = 'drop'
        )
      
      cat("Gathered read counts for", nrow(umi_read_counts), "UMIs from", 
          n_distinct(umi_read_counts$cellID), "cells\n")
      
      # Create a wide format with UMI counts per category
      umi_by_category <- umi_read_counts %>%
        group_by(cellID, category) %>%
        summarize(
          category_UMIs = n_distinct(UMI),
          category_reads = sum(read_count),
          .groups = 'drop'
        )
      
      # Use pivot_wider to create a wide format
      umi_by_category_wide <- tidyr::pivot_wider(
        umi_by_category,
        id_cols = cellID,
        names_from = category,
        names_sep = "_",
        values_from = c(category_UMIs, category_reads),
        values_fill = 0)
      
      # Apply raw_cellIDs filtering
      if (sample %in% names(raw_cellIDs) && !is.null(raw_cellIDs[[sample]])) {
        valid_cells <- raw_cellIDs[[sample]]
        cat("Keeping only cells in", 
            length(valid_cells), "valid cells from 10X data\n")
        
        # Filter the UMI-level data
        valid_umi_read_counts <- umi_read_counts %>%
          filter(cellID %in% valid_cells)
        
        # Filter the UMI-level data
        filtered_umi_read_counts <- umi_read_counts %>%
          filter(cellID %in% valid_cells)
      }
      
      # No multimap correction
      
      # Save the detailed UMI-level data (both filtered and unfiltered)
      umi_level_file <- file.path(output.dir, paste0(sample, "_UMI_read_counts_raw.csv"))
      write.csv(umi_read_counts, file = umi_level_file, row.names = FALSE)
      
      filtered_umi_level_file <- file.path(output.dir, paste0(sample, "_UMI_read_counts_full.csv"))
      write.csv(filtered_umi_read_counts, file = filtered_umi_level_file, row.names = FALSE)
      
      cat("Successfully processed\n")
      rm(umi_by_category, umi_by_category_wide, umi_read_counts)
    }, error = function(e) {
      cat("Error processing data for sample", sample, ":", conditionMessage(e), "\n")
      
      # Try to save the raw data at least
      raw_file <- file.path(output.dir, paste0(sample, "_raw_data.csv"))
      write.csv(all_data, file = raw_file, row.names = FALSE)
      cat("Saved raw data to:", raw_file, "\n")
    })
  }
}

# minimums
input_dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/bamsort/reads/KLRB1"
output_dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/bamsort/reads/KLRB1/minimum" 

process_all_set_minimums("KLRB1", samples$samples, input_dir, output_dir, min_reads = 2, min_region_count = 1, min_umi = 2, min_cells = 2)
```

```{r joint}
# Loading
GEX_data <- list()

samples <- data.frame(
  datasets = c(
    "P_acute_GEX",
    "W0"
  ),
  samples = c(
    "Pacute",
    "Uninfected"
  ),
  folders = c(
    "/projects/b1042/GoyalLab/egrody/extractedData/EGS009/singleCell/counts/Mmul_10_mac239/",
    "/projects/b1042/GoyalLab/egrody/extractedData/EGS002/singleCell/counts/Mmul_10_mac239/"
  )
)

for (i in 1:nrow(samples)) {
  dataset_name <- samples$datasets[i]
  sample_name <- samples$samples[i]
  folder_path <- paste0(samples$folders[i], "expressionDF/")
  
  tryCatch({
    # Read CSV
    input_filename <- paste0(folder_path, dataset_name, "_KLRB1.csv")
    data <- read.csv(input_filename)
    data <- data %>%
      select(-X)
   
    # Store the data with the sample name
    GEX_data[[sample_name]] <- data
   
    cat("Processed sample:", dataset_name, "as", sample_name, "\n")
 }, error = function(e) {
    cat("Error processing", dataset_name, ":", conditionMessage(e), "\n")
 })
  rm(data)
}

input.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/bamsort/reads/KLRB1"
SALVE_data <- read_sample_files(samples$samples, input.dir, filtered = FALSE)


# Joint
joint_data <- list()
for (i in 1:nrow(samples)) {
  sample_name <- samples$samples[i]
  
  tryCatch({
    SALVE <- SALVE_data %>%
      filter(sample == sample_name) %>%
      rename(SALVE = read_count) %>%
      select(cellID, SALVE) %>%
      group_by(cellID) %>% 
    summarize(SALVE = sum(SALVE), .groups = 'drop')
    GEX <- GEX_data[[sample_name]] %>%
      rename(GEX = KLRB1)
    joint_data[[sample_name]] <- left_join(GEX, SALVE, by = "cellID")
    
    cat("Processed sample:", sample_name, "\n")
  }, error = function(e) {
    cat("Error processing", sample_name, ":", conditionMessage(e), "\n")
  })
}

joint_data <- lapply(joint_data, function(x) {
  x[is.na(x)] <- 0
  return(x)
})

```

```{r}
cat("\nSample\tTotal_cells\tboth\t10X_only\tSALVE_only\n")

# Process each dataset in the joint_data list
for (sample_name in names(joint_data)) {
  # Get the current dataframe
  current_df <- joint_data[[sample_name]] #%>%
    #mutate(SALVE = (D1_US + D1_S + tat_S + tat_US + nef )) %>%
    #mutate(GEX = (LTR_D1  + D1_A1  + A1_D4 + D4_A7 + A7_LTR))
  
  # Create the subsets based on mac239 and total columns
  both <- current_df %>% filter(GEX != 0 & SALVE != 0)
  onlySingleCell <- current_df %>% 
    filter(GEX != 0) %>%
    filter(!(cellID %in% both$cellID))
  onlySALVE <- current_df %>% 
    filter(SALVE != 0) %>%
    filter(!(cellID %in% both$cellID))

  
  # Print data row for each sample
  cat(sample_name, "\t", 
      nrow(current_df), "\t", 
      nrow(both), "\t", 
      nrow(onlySingleCell), "\t", 
      nrow(onlySALVE), "\n")
  
  # Save CSVs
  #write.csv(both, paste0(output_dir, "left_", sample_name, "_both.csv"), row.names = FALSE)
  #write.csv(onlySingleCell, paste0(output_dir, "left_", sample_name, "_onlySingleCell.csv"), row.names = FALSE)
  #write.csv(onlySALVE, paste0(output_dir, "left_", sample_name, "_onlySALVE.csv"), row.names = FALSE)
  #write.csv(current_df, paste0(output_dir, "left_", sample_name, "_all.csv"), row.names = FALSE)
}
```
### Seurat
```{r process}
samples <- data.frame(
  samples = c(
    "Pacute",
    "Uninfected"
  ),
  folders = c(
    "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/counts/concat/Mmul_10_mac239_Pacute_pool_KLRB1_CI/outs/raw_feature_bc_matrix/",
    "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/counts/concat/Mmul_10_mac239_W0_KLRB1_CI/outs/raw_feature_bc_matrix/"
  )
)

# Process each sample
for (i in 1:nrow(samples)) {
  sample_name <- samples$samples[i]
  folder_path <- samples$folders[i]
  
  tryCatch({
    # Process the current sample
    seurat_obj <- SeuratSALVEseq(folder_path, sample_name, plots = FALSE)
    
    # Generate the target expression data frame
    singlecell_df <- targetExpressionDF(seurat_obj, "KLRB1")
    
    output_dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/expressionDF/"
    
    # Write the CSV
    output_filename <- paste0(output_dir, sample_name, "_KLRB1.csv")
    write.csv(singlecell_df, output_filename)
    
    cat("Processed sample:", sample_name, "\n")
    cat("Saved to:", output_filename, "\n\n")
  }, error = function(e) {
    cat("Error processing sample", sample_name, ":", conditionMessage(e), "\n\n")
  })
}
```
```{r joint}
# load GEX
GEX_data <- list()

samples <- data.frame(
  datasets = c(
    "P_acute_GEX",
    "W0"
  ),
  samples = c(
    "Pacute",
    "Uninfected"
  ),
  folders = c(
    "/projects/b1042/GoyalLab/egrody/extractedData/EGS009/singleCell/counts/Mmul_10_mac239/",
    "/projects/b1042/GoyalLab/egrody/extractedData/EGS002/singleCell/counts/Mmul_10_mac239/"
  )
)

for (i in 1:nrow(samples)) {
  dataset_name <- samples$datasets[i]
  sample_name <- samples$samples[i]
  folder_path <- paste0(samples$folders[i], "expressionDF/")
  
  tryCatch({
    # Read CSV
    input_filename <- paste0(folder_path, dataset_name, "_KLRB1.csv")
    data <- read.csv(input_filename)
    data <- data %>%
      select(-X)
   
    # Store the data with the sample name
    GEX_data[[sample_name]] <- data
   
    cat("Processed sample:", dataset_name, "as", sample_name, "\n")
 }, error = function(e) {
    cat("Error processing", dataset_name, ":", conditionMessage(e), "\n")
 })
  rm(data)
}


# load SALVE
SALVE_Seurat <- list()

samples <- data.frame(
  samples = c(
    "Pacute",
    "Uninfected"
  ),
  folders = c(
    "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/counts/concat/Mmul_10_mac239_Pacute_pool_KLRB1_CI/outs/raw_feature_bc_matrix/",
    "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/counts/concat/Mmul_10_mac239_W0_KLRB1_CI/outs/raw_feature_bc_matrix/"
  )
)

for (i in 1:nrow(samples)) {
  sample_name <- samples$samples[i]
  folder_path <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/expressionDF/"
  
  tryCatch({
    # Read CSV
    input_filename <- paste0(folder_path, sample_name, "_KLRB1.csv")
    data <- read.csv(input_filename)
    data <- data %>%
      select(-X)
   
    # Store the data with the sample name
    SALVE_Seurat[[sample_name]] <- data
   
    cat("Processed sample:", sample_name, "\n")
 }, error = function(e) {
    cat("Error processing", sample_name, ":", conditionMessage(e), "\n")
 })
  rm(data)
}

# Joint
joint_data <- list()
for (i in 1:nrow(samples)) {
  sample_name <- samples$samples[i]
  
  tryCatch({
    SALVE <- SALVE_Seurat[[sample_name]] %>%
      rename(SALVE = KLRB1)
    GEX <- GEX_data[[sample_name]] %>%
      rename(GEX = KLRB1)
    joint_data[[sample_name]] <- left_join(GEX, SALVE, by = "cellID")
    
    cat("Processed sample:", sample_name, "\n")
  }, error = function(e) {
    cat("Error processing", sample_name, ":", conditionMessage(e), "\n")
  })
}

joint_data <- lapply(joint_data, function(x) {
  x[is.na(x)] <- 0
  return(x)
})
```

```{r}
cat("\nSample\tTotal_cells\tboth\t10X_only\tSALVE_only\n")

# Process each dataset in the joint_data list
for (sample_name in names(joint_data)) {
  # Get the current dataframe
  current_df <- joint_data[[sample_name]] #%>%
    #mutate(SALVE = (D1_US + D1_S + tat_S + tat_US + nef )) %>%
    #mutate(GEX = (LTR_D1  + D1_A1  + A1_D4 + D4_A7 + A7_LTR))
  
  # Create the subsets based on mac239 and total columns
  both <- current_df %>% filter(GEX != 0 & SALVE != 0)
  onlySingleCell <- current_df %>% 
    filter(GEX != 0) %>%
    filter(!(cellID %in% both$cellID))
  onlySALVE <- current_df %>% 
    filter(SALVE != 0) %>%
    filter(!(cellID %in% both$cellID))

  
  # Print data row for each sample
  cat(sample_name, "\t", 
      nrow(current_df), "\t", 
      nrow(both), "\t", 
      nrow(onlySingleCell), "\t", 
      nrow(onlySALVE), "\n")
  
  # Save CSVs
  #write.csv(both, paste0(output_dir, "left_", sample_name, "_both.csv"), row.names = FALSE)
  #write.csv(onlySingleCell, paste0(output_dir, "left_", sample_name, "_onlySingleCell.csv"), row.names = FALSE)
  #write.csv(onlySALVE, paste0(output_dir, "left_", sample_name, "_onlySALVE.csv"), row.names = FALSE)
  #write.csv(current_df, paste0(output_dir, "left_", sample_name, "_all.csv"), row.names = FALSE)
}
```

```{r}
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/joint/KLRB1"
plotUMAP(joint_data[["Uninfected"]], SALVE, "Uninfected: KLRB1 from SALVE", output.dir, "Uninfected_umap_SALVE.svg")
```



## Joint

### bamsort
Loading both datasets and making left_join dataframe
```{r}
SingleCell_Pacute <- read.csv("/projects/b1042/GoyalLab/egrody/extractedData/EGS009/singleCell/counts/Mmul_10_mac239/expressionDF/Pacute_Mmulmac_mac239.csv", row.names = "X")
Pacute_SALVE <- read.csv("/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/bamsort/Pacute_SALVE_filtered.csv", row.names = "X")

Pacute_paint_umap = left_join(SingleCell_Pacute, Pacute_SALVE, by = "cellID")
Pacute_paint_umap[is.na(Pacute_paint_umap)] <- 0

```

To get metrics for the left_join dataframe:
```{r}
left_both <- Pacute_paint_umap %>% filter(mac239 != 0 & absolute != 0)
left_onlySingleCell <- Pacute_paint_umap %>% filter(mac239 != 0) %>%
  filter(!(cellID %in% left_both$cellID))
left_onlySALVE <- Pacute_paint_umap %>% filter(absolute != 0)  %>%
  filter(!(cellID %in% left_both$cellID))
cat("Left_join\nTotal cells: \t\t", nrow(Pacute_paint_umap),
  "\nCells in both: \t\t", nrow(left_both),
  "\nCells in 10X only: \t", nrow(left_onlySingleCell),
    "\nCells in SALVE only: \t", nrow(left_onlySALVE))


output_dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/joint/"
write.csv(left_both, paste0(output_dir, "left_both.csv"))
write.csv(left_onlySingleCell, paste0(output_dir, "left_onlySingleCell.csv"))
write.csv(left_onlySALVE, paste0(output_dir, "left_onlySALVE.csv"))

```
To make full_join dataframe and get metrics:
```{r}
Pacute_paint_umap_full = full_join(SingleCell_Pacute, Pacute_SALVE, by = "cellID")
Pacute_paint_umap_full[is.na(Pacute_paint_umap_full)] <- 0

# how many mac239+ cells from each method?
full_both <- Pacute_paint_umap_full %>% filter(mac239 != 0 & absolute != 0)
full_onlySingleCell <- Pacute_paint_umap_full %>% filter(mac239 != 0) %>%
  filter(!(cellID %in% full_both$cellID))
full_onlySALVE <- Pacute_paint_umap_full %>% filter(absolute != 0) %>%
  filter(!(cellID %in% full_both$cellID))
unanchored <- full_onlySALVE %>% filter(!(cellID %in% left_onlySALVE$cellID))
cat("Full_join\nTotal cells: \t\t", nrow(Pacute_paint_umap_full),
  "\nCells in both: \t\t", nrow(full_both),
  "\nCells in 10X only: \t", nrow(full_onlySingleCell),
    "\nCells in SALVE only: \t", nrow(full_onlySALVE),
  "\nUnanchored SALVE: \t", nrow(unanchored))

output_dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/joint/"
write.csv(full_both, paste0(output_dir, "full_both.csv"))
write.csv(full_onlySingleCell, paste0(output_dir, "full_onlySingleCell.csv"))
write.csv(full_onlySALVE, paste0(output_dir, "full_onlySALVE.csv"))
```

Plotting
```{r}
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/joint/"
plotUMAP(Pacute_paint_umap, mac239, "Pacute: mac239", output.dir, "Pacute_umap_singleCell.svg")
plotUMAP(Pacute_paint_umap, total_lessLTR, "Pacute: SALVE (total_lessLTR)", output.dir, "Pacute_umap_SALVE.svg")

plotUMAP(Pacute_paint_umap, mac239, "Pacute: mac239", output.dir, "Pacute_umap_singleCell.svg", color_max = max(Pacute_paint_umap$total_lessLTR))
plotUMAP(Pacute_paint_umap, total_lessLTR, "Pacute: SALVE (total_lessLTR)", output.dir, "Pacute_umap_SALVE_totallessLTR.svg")
plotUMAP(Pacute_paint_umap, tat_S, "Pacute: SALVE (tat S)", output.dir, "Pacute_umap_SALVE_tatS.svg")
plotUMAP(Pacute_paint_umap, tat_US, "Pacute: SALVE (tat US)", output.dir, "Pacute_umap_SALVE_tatUS.svg")
plotUMAP(Pacute_paint_umap, D1_S, "Pacute: SALVE (D1 S)", output.dir, "Pacute_umap_SALVE_D1S.svg")
plotUMAP(Pacute_paint_umap, D1_US, "Pacute: SALVE (D1 US)", output.dir, "Pacute_umap_SALVE_D1US.svg")
plotUMAP(Pacute_paint_umap, absolute, "Pacute: SALVE (absolute)", output.dir, "Pacute_umap_SALVE_absolute.svg")

Pacute_paint_umap <- Pacute_paint_umap %>%
  mutate(across(c(D1_US, D1_S, tat_US, tat_S), 
                ~ ifelse(.x < 1, 0, .x))) %>%
  mutate(allspliced = (D1_S + tat_S))
  
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/joint/lightning/"
plotUMAP(Pacute_paint_umap, allspliced, "Pacute: SALVE (all spliced)", output.dir, "Pacute_umap_SALVE_allsplice.svg",
         color = "red")
plotUMAP(Pacute_paint_umap, D1_US, "Pacute: SALVE (unspliced)", output.dir, "Pacute_umap_SALVE_US.svg",
         color = "orange")




cat(
  "Number of US (unspliced) cells: \t",
  sum(Pacute_paint_umap$D1_US > 0),
  "\nNumber of S (spliced) cells: \t\t",
  sum(Pacute_paint_umap$D1_S > 0 | Pacute_paint_umap$tat_S > 0),
  "\nNumber of cells with both: \t\t",
  sum(Pacute_paint_umap$D1_US > 0 & (Pacute_paint_umap$D1_S > 0 | Pacute_paint_umap$tat_S > 0))
)
```

### Seurat (skip)
Skip down to "Seurat, with EGS009"
```{r SKIP TO WITH EGS009}
# loading
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS009/singleCell/counts/Mmul_10_mac239/expressionDF/"
GEX_mac239 <- read.csv(paste0(output.dir, "Pacute_Mmulmac_mac239.csv"))
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/singleCell/counts/expressionDF/"
GEX_isoforms <- read.csv(paste0(output.dir, "Pacute_isoforms.csv"))
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/counts/concat/expressionDF/"
SALVE_isoforms <- read.csv(paste0(output.dir, "SALVE_isoforms_Mmulmacv4_rawcounts.csv"))
SALVE_mac239 <- read.csv(paste0(output.dir, "SALVE_combined_Mmulmac_rawcounts.csv"))

SALVE <- SALVE_isoforms %>%
  filter(sample == "Pacute") %>%
  group_by(cellID) %>%
  #filter(n_distinct(target) == 2 & 
  #   all(c("D1_up_PL", "LTR_tat") %in% target)) %>% # in both sequencing libs
  summarise(across(c(US, spliced, S, SS, MS, any), \(x) sum(x, na.rm = TRUE)), .groups = 'drop') %>%
  ungroup() %>%
  filter(US > 0) %>%
  #filter(rowSums(across(c(US, spliced, S, SS, MS, any)) > 0) > 2) %>% #more than 2 genes
  mutate(SALVE = rowSums(across(c(US, spliced, S, SS, MS, any)))) %>%
  #{if(nrow(.) > 0) filter(., SALVE != min(SALVE, na.rm = TRUE)) else .} %>%
  #select(cellID, SALVE) %>%
  mutate(SALVE = if(nrow(.) > 0) log1p(SALVE) else numeric(0))
GEX <- GEX_isoforms %>%
  select(-sample, -X) %>%
  mutate(GEX = rowSums(across(c(US, spliced, any))))%>%
  mutate(GEX = if(nrow(.) > 0) log1p(GEX) else numeric(0))
# GEX <- GEX_mac239 %>%
#   mutate(GEX = if(nrow(.) > 0) log1p(mac239) else numeric(0))
# SALVE <- SALVE_mac239 %>%
#   select(-sample, -target) %>%
#   group_by(cellID) %>%
#   summarise(across(mac239, \(x) sum(x, na.rm = TRUE)), .groups = 'drop') %>%
#   ungroup() %>%
#   mutate(SALVE = if(nrow(.) > 0) log1p(mac239) else numeric(0))

joint_data <- left_join(GEX, SALVE, by = "cellID")
joint_data[is.na(joint_data)] <- 0

```

```{r SKIP}

# Get the current dataframe
# joint_data <- joint_data %>%
#   mutate(all_spliced = spliced.y + S + SS + MS)

# Create the subsets based on mac239 and total columns
both <- joint_data %>% filter(GEX != 0 & SALVE != 0)
onlySingleCell <- joint_data %>% 
  filter(GEX != 0) %>%
  filter(!(cellID %in% both$cellID))
onlySALVE <- joint_data %>% 
  filter(SALVE != 0) %>%
  filter(!(cellID %in% both$cellID))


cat("\nSample\tTotal_cells\tboth\t10X_only\tSALVE_only\nPacute\t",
    nrow(joint_data), "\t",
    nrow(both), "\t",
    nrow(onlySingleCell), "\t",
    nrow(onlySALVE), "\n")

cat("Pacute\tCorrelation:", cor(both$GEX, both$SALVE), "\n")


p <- ggplot(joint_data, aes(x = SALVE, y = GEX)) +
  geom_point() +
  labs(
      x = "SALVE total",
      y = "GEX total",
      title = paste("Correlation for ", sample_name)
    ) +
    theme_minimal()

print(p)



# pearson_cor <- cor(current_df$all_spliced, current_df$spliced.x, use = "complete.obs")
# r_squared <- pearson_cor^2
# lm_model <- lm(spliced.x ~ all_spliced, data = current_df)
# slope <- coef(lm_model)[2]
# p <- ggplot(data = current_df, aes(x = all_spliced, y = spliced.x)) +
#     geom_point() +
#   geom_smooth(method = "lm", se = TRUE, color = "red") +
#     labs(
#       x = "SALVE spliced",
#       y = "GEX spliced",
#       title = paste("Correlation for ", sample_name)
#     ) +
#     theme_minimal()# +
#     # annotate("text", 
#     #      x = -Inf, y = Inf, 
#     #      label = paste("Slope =", round(slope, 3), "\n",
#     #                   "R² =", round(r_squared, 3), "\n",
#     #                   "r =", round(pearson_cor, 3)), 
#     #      hjust = -0.1, vjust = 1.2, 
#     #      size = 4, color = "black")
# print(p)
# 

# Save CSVs
#write.csv(both, paste0(output_dir, "left_", sample_name, "_both.csv"), row.names = FALSE)
#write.csv(onlySingleCell, paste0(output_dir, "left_", sample_name, "_onlySingleCell.csv"), row.names = FALSE)
#write.csv(onlySALVE, paste0(output_dir, "left_", sample_name, "_onlySALVE.csv"), row.names = FALSE)
#write.csv(current_df, paste0(output_dir, "left_", sample_name, "_all.csv"), row.names = FALSE)

```


### Seurat, with EGS009

```{r}
# loading
#output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS009/singleCell/counts/Mmul_10_mac239/expressionDF/"
#GEX_mac239 <- read.csv(paste0(output.dir, "Pacute_Mmulmac_mac239.csv"))
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/singleCell/counts/expressionDF/"
GEX_isoforms <- read.csv(paste0(output.dir, "Pacute_isoforms.csv"))
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/counts/concat/expressionDF/"
SALVE_EGS013 <- read.csv(paste0(output.dir, "SALVE_isoforms_Mmulmacv4_rawcounts.csv"))
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS009/SALVE/counts/v4/expressionDF/"
SALVE_EGS009 <- read.csv(paste0(output.dir, "SALVE_isoforms_rawcounts.csv"))


# GEX <- GEX_mac239 %>%
#   mutate(GEX = if(nrow(.) > 0) log1p(mac239) else numeric(0))

EGS009 <- SALVE_EGS009 %>%
  filter(sample == "P_acute") %>%
  group_by(cellID) %>%
  summarise(across(c(US, spliced, S, SS, MS, any), \(x) sum(x, na.rm = TRUE)), .groups = 'drop') %>%
  ungroup() %>%
  filter(US > 0) %>%
  mutate(SALVE = rowSums(across(c(US, spliced, S, SS, MS, any))))
EGS013 <- SALVE_EGS013 %>%
  filter(sample == "Pacute") %>%
  group_by(cellID) %>%
  summarise(across(c(US, spliced, S, SS, MS, any), \(x) sum(x, na.rm = TRUE)), .groups = 'drop') %>%
  ungroup() %>%
  filter(US > 0) %>%
  mutate(SALVE = rowSums(across(c(US, spliced, S, SS, MS, any))))

# First joining SALVEs
joint_SALVE <- rbind(EGS009, EGS013)
joint_SALVE <- joint_SALVE %>%
  group_by(cellID) %>%
  summarise(across(c(US, spliced, S, SS, MS, any, SALVE), \(x) sum(x, na.rm = TRUE)), .groups = 'drop') %>%
  ungroup() %>%
  mutate(SALVE = if(nrow(.) > 0) log1p(SALVE) else numeric(0))
  

# Now join to GEX
GEX <- GEX_isoforms %>%
  select(-sample, -X) %>%
  mutate(GEX = rowSums(across(c(US, spliced, any))))%>%
  mutate(GEX = if(nrow(.) > 0) log1p(GEX) else numeric(0))

joint_data <- left_join(GEX, joint_SALVE, by = "cellID")
#joint_data <- left_join(GEX, EGS009, by = "cellID")
joint_data[is.na(joint_data)] <- 0

```


```{r}
# Create the subsets based on GEX and SALVE columns
both <- joint_data %>% filter(GEX != 0 & SALVE != 0)
onlySingleCell <- joint_data %>% 
  filter(GEX != 0) %>%
  filter(!(cellID %in% both$cellID))
onlySALVE <- joint_data %>% 
  filter(SALVE != 0) %>%
  filter(!(cellID %in% both$cellID))


cat("\nSample\tTotal_cells\tboth\t10X_only\tSALVE_only\nPacute\t",
    nrow(joint_data), "\t",
    nrow(both), "\t",
    nrow(onlySingleCell), "\t",
    nrow(onlySALVE), "\n")

cat("Pacute\tCorrelation:", cor(both$GEX, both$SALVE), "\n")


p <- ggplot(joint_data, aes(x = SALVE, y = GEX)) +
  geom_point() +
  labs(
      x = "SALVE total",
      y = "GEX total",
      title = paste("Correlation for Pacute")
    ) +
    theme_minimal()

print(p)


# pearson_cor <- cor(current_df$all_spliced, current_df$spliced.x, use = "complete.obs")
# r_squared <- pearson_cor^2
# lm_model <- lm(spliced.x ~ all_spliced, data = current_df)
# slope <- coef(lm_model)[2]
# p <- ggplot(data = current_df, aes(x = all_spliced, y = spliced.x)) +
#     geom_point() +
#   geom_smooth(method = "lm", se = TRUE, color = "red") +
#     labs(
#       x = "SALVE spliced",
#       y = "GEX spliced",
#       title = paste("Correlation for ", sample_name)
#     ) +
#     theme_minimal()# +
#     # annotate("text", 
#     #      x = -Inf, y = Inf, 
#     #      label = paste("Slope =", round(slope, 3), "\n",
#     #                   "R² =", round(r_squared, 3), "\n",
#     #                   "r =", round(pearson_cor, 3)), 
#     #      hjust = -0.1, vjust = 1.2, 
#     #      size = 4, color = "black")
# print(p)
# 

# Save CSVs
output_dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/joint/v4/"
write.csv(both, paste0(output_dir, "left_Pacute_both.csv"), row.names = FALSE)
write.csv(onlySingleCell, paste0(output_dir, "left_Pacute_onlySingleCell.csv"), row.names = FALSE)
write.csv(onlySALVE, paste0(output_dir, "left_Pacute_onlySALVE.csv"), row.names = FALSE)
write.csv(joint_data, paste0(output_dir, "left_Pacute_all.csv"), row.names = FALSE)

```

Plotting some paint UMAPs. I changed the color of the plot by adding the optional variable "color".
```{r plotting}
current_df <- joint_data %>%
    mutate(all_spliced = spliced.y + S + SS + MS) %>%
  mutate(all_spliced = log1p(all_spliced)) %>%
  mutate(spliced.x = log1p(spliced.x)) %>%
  mutate(US.x = log1p(US.x)) %>%
  mutate(US.y = log1p(US.y)) %>%
  mutate(US.to.S.x = ifelse(spliced.x == 0, 0, US.x / spliced.x)) %>%
  mutate(US.to.S.y = ifelse(all_spliced == 0, 0, US.y / all_spliced))
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/joint/v4/"
plotUMAP(current_df, US.to.S.y, "Pacute EGS013 + EGS009: SALVE US/S", output.dir, "Pacute_umap_SALVE_UStoS.svg")
```


### Correlation analysis
Will do it custom for now and update correlation plot function later
```{r}
cat(
  "Correlation between 10X mac239 and SALVE total_lessLTR:\n",
    "  Pearson: ", round(cor(Pacute_paint_umap$mac239, Pacute_paint_umap$total_lessLTR, method="pearson"), 3),
    "\n  Spearman: ", round(cor(Pacute_paint_umap$mac239, Pacute_paint_umap$total_lessLTR, method="spearman"), 3),
    
    "\n\nCorrelation between 10X mac239 and SALVE absolute:\n",
    "  Pearson: ", round(cor(Pacute_paint_umap$mac239, Pacute_paint_umap$absolute, method="pearson"), 3),
    "\n  Spearman: ", round(cor(Pacute_paint_umap$mac239, Pacute_paint_umap$absolute, method="spearman"), 3)
)

# plotting
plot <- ggplot(data = Pacute_paint_umap, aes(x = total_lessLTR, y = mac239)) +
      geom_point() +
      labs(
        x = "SALVE total counts: D1 + tat + nef (filter > 2)",
        y = "SingleCell mac239 counts",
        title = "Pacute joint: total count") +
      theme_minimal() + 
    coord_fixed(ratio = 1)
plot <- ggplot(data = Pacute_paint_umap, aes(x = absolute, y = mac239)) +
      geom_point() +
      labs(
        x = "SALVE absolute (5' LTR) counts (filter > 0)",
        y = "SingleCell mac239 counts",
        title = "Pacute joint: absolute count") +
      theme_minimal() +
    coord_fixed(ratio = 1)
plot + theme(aspect.ratio = 1)
```




## Subset analysis

### Loading
```{r}
Pacute_paint_umap <- read.csv("/projects/b1042/GoyalLab/egrody/extractedData/EGS013/joint/v4/left_Pacute_all.csv")

output_dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/joint/v4/subset/"
plotUMAP(Pacute_paint_umap, SALVE, "Total SALVE",
                                output_dir, 
                                saveas = "Pacute_umap_SALVE.svg")

umap_me <- Pacute_paint_umap %>%
  mutate(SALVE = ifelse(SALVE == min(SALVE[SALVE != 0], na.rm = TRUE), 
                              0, SALVE))

plotUMAP(umap_me, SALVE, "Total SALVE with minimum",
                                output_dir, 
                                saveas = "Pacute_umap_SALVE_min.svg")

# little test
# plot_me <- joint_data %>%
#   mutate(SALVE = if(nrow(.) > 0) log1p(SALVE) else numeric(0))
# output_dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/joint/v4/subset/"
# plotUMAP(plot_me, SALVE, "EGS009 SALVE",
#                                 output_dir, 
#                                 saveas = "Pacute_umap_SALVE_EGS009.svg")
```


```{r plotting}
# Function to create Seurat-style DimPlot
plot_clusters <- function(data, 
                         label_clusters = TRUE,
                         pt_size = 0.5,
                         label_size = 4) {
  
  # Convert the cluster column to a factor
  data$cluster <- as.factor(data$cluster)
  
  n_clusters <- length(unique(data$cluster))
  cluster_colors <- scales::hue_pal()(n_clusters)
  
  p1 <- ggplot(data, aes(x = UMAP1, y = UMAP2, color = cluster)) +
    geom_point(size = pt_size) +
    scale_color_manual(values = cluster_colors) +
    theme_bw() +
    theme(
      panel.grid = element_blank(),
      axis.title = element_text(size = 12),
      legend.title = element_blank(),
      panel.border = element_rect(colour = "black", fill = NA)
    )
  
  if (label_clusters) {
    cluster_centers <- data %>%
      group_by(cluster) %>%
      summarise(
        UMAP1 = median(UMAP1),
        UMAP2 = median(UMAP2)
      )
    
    p1 <- p1 + geom_text(data = cluster_centers,
                         aes(label = cluster),
                         size = label_size,
                         color = "black")
  }
  
  return(p1)
}

output_dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/joint/v4/subset/"
cluster_plot <- plot_clusters(Pacute_paint_umap)
ggsave(cluster_plot, file = paste0(output_dir, "Pacute_umap_cluster.svg"))
plotUMAP(Pacute_paint_umap, SALVE, "Total SALVE",
                                output_dir, 
                                saveas = "Pacute_umap_SALVE.svg")
plotUMAP(Pacute_paint_umap, GEX, "Total GEX",
                                output_dir, 
                                saveas = "Pacute_umap_GEX.svg")
intersect_umap <- Pacute_paint_umap %>%
  mutate(SALVE = ifelse(GEX == 0, 0, SALVE))
plotUMAP(intersect_umap, SALVE, "Total SALVE in GEX+ cells",
                                output_dir, 
                                saveas = "Pacute_umap_intersect.svg") #SALVE xprn in cells that are 10X+


```

### Splice classes
```{r}
splicesplicebaby <- umap_me %>%
  mutate(all_spliced = spliced.y + S + SS + MS) %>%
  select(-any.x, -any.y) %>%
  mutate(US.to.S.x = ifelse(spliced.x == 0, 0, US.x / spliced.x)) %>%
  mutate(US.to.S.y = ifelse(all_spliced == 0, 0, US.y / all_spliced)) %>%
  mutate(class.y = case_when(
    (US.to.S.y == 0 & US.y > 0) ~ "USonly",
    (US.to.S.y > 0 & US.y > 0) ~ "USS",
    TRUE ~ "none"  # for any remaining cases
  )) %>%
  mutate(class.x = case_when(
    (US.to.S.x == 0 & US.x > 0) ~ "USonly",
    (US.to.S.x > 0 & US.x > 0) ~ "USS",
    TRUE ~ "none"  # for any remaining cases
  ))


```


### DEG analysis

First, comparing any SALVE to any GEX
```{r}
Pacute <- SeuratPipeline("/projects/b1042/GoyalLab/egrody/extractedData/EGS009/singleCell/counts/Mmul_10/Mmul_10_P_acute_GEX/outs/filtered_feature_bc_matrix/", "Pacute", plots = FALSE)

list_of_cells <- splicesplicebaby %>% filter(SALVE > 0) # for SALVE US only
list_of_cells <- splicesplicebaby %>% filter(GEX > 0) #for 10X US only
list_of_cells <- list_of_cells$cellID

results <- analyze_cell_subset(Pacute, list_of_cells)
```

Splicing
```{r}
list_of_cells <- splicesplicebaby %>% filter(class.y == "USonly") # for SALVE US only
list_of_cells <- splicesplicebaby %>% filter(class.x == "USonly") #for 10X US only
list_of_cells <- splicesplicebaby %>% filter(class.y == "USS") # for SALVE US & S
list_of_cells <- splicesplicebaby %>% filter(class.x == "USS") #for 10X US & S
list_of_cells <- splicesplicebaby %>% filter(class.x == "USS" | class.y == "USS") #for US & S in either
list_of_cells <- list_of_cells$cellID

#This analysis takes ~8 minutes
results <- analyze_cell_subset(Pacute, list_of_cells)
```



### Saving results
```{r}
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/joint/v4/subset/SALVE/USSeither/"
save_subset_analysis(results, output_dir = output.dir)
#plot_subset_analysis(Pacute, results, list_of_cells, output_dir = paste0(output.dir, "plots/"))
```

### Interpreting results
```{r}
# load back in results
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/joint/v4/subset/GEX/"
sheet_names <- getSheetNames(paste0(output.dir, "cluster_specific_DE.xlsx"))
cluster_specific <- lapply(sheet_names, function(x) {
  read.xlsx(paste0(output.dir, "cluster_specific_DE.xlsx"), sheet = x)
})
names(cluster_specific) <- sheet_names

# Create filtered results list
filteredDEG <- lapply(cluster_specific, function(df) {
  if (!is.null(df) && nrow(df) > 0) {
    # Filter for significant adjusted p-value and log2FC threshold
    df[df$p_val_adj < 0.05 & abs(df$avg_log2FC) > 0.5, ]
  } else {
    NULL
  }
})

# Remove any empty results
filteredDEG <- filteredDEG[sapply(filteredDEG, function(x) !is.null(x) && nrow(x) > 0)]

# Print summary of how many genes passed filters in each cluster
for (cluster in names(filteredDEG)) {
  cat(sprintf("Cluster %s: %d genes\n", cluster, nrow(filteredDEG[[cluster]])))
}

# Saving
wb <- createWorkbook()
# Add each cluster's results as a separate worksheet
for (cluster_name in names(filteredDEG)) {
    de_results <- filteredDEG[[cluster_name]]
    if (!is.null(de_results) && nrow(de_results) > 0) {
        # Add cluster results as a worksheet
        addWorksheet(wb, cluster_name)
        # Add data with gene names as a column
        de_results$gene <- rownames(de_results)
        writeData(wb, cluster_name, de_results)
    }
}

# Save the workbook
saveWorkbook(wb, paste0(output.dir, "cluster_specific_DE_filtered.xlsx"), overwrite = TRUE)




conserved_markers <- read.xlsx(paste0(output.dir, "conserved_markers.xlsx"), sheet = "conserved_markers")
filteredConserv <- conserved_markers %>%
    filter(p_val_adj < 0.05 & abs(avg_log2FC) > 0.5)

# Print summary of how many genes passed filters in each cluster
cat(sprintf("Conserved markers: %d genes\n", nrow(filteredConserv)))

# For each gene in conserved_markers, let's check which clusters show it as significant
check_gene_presence <- function(gene, cluster_results, p_val_thresh = 0.05, log2fc_thresh = 0.5) {
  # Initialize list to store results
  presence <- list()
  
  # Check each cluster
  for(cluster in names(cluster_results)) {
    de_results <- cluster_results[[cluster]]
    if(!is.null(de_results) && gene %in% rownames(de_results)) {
      # Get gene stats for this cluster
      gene_stats <- de_results[gene,]
      # Check if it meets significance criteria
      if(gene_stats$p_val_adj < p_val_thresh && abs(gene_stats$avg_log2FC) > log2fc_thresh) {
        presence[[cluster]] <- c(
          p_val_adj = gene_stats$p_val_adj,
          avg_log2FC = gene_stats$avg_log2FC
        )
      }
    }
  }
  
  # Return number of clusters and which clusters
  return(list(
    n_clusters = length(presence),
    clusters = names(presence),
    details = presence
  ))
}

# First get cluster counts for each gene
cluster_counts <- lapply(rownames(filteredConserv), function(gene) {
  result <- check_gene_presence(gene, cluster_specific)
  data.frame(
    gene = gene,
    num_clusters = result$n_clusters,
    clusters = paste(result$clusters, collapse=",")
  )
}) %>% bind_rows()

# Add cluster information to filtered results
filteredConserv <- filteredConserv %>%
  mutate(gene = rownames(.)) %>%
  left_join(cluster_counts, by = "gene") %>%
  arrange(desc(num_clusters), desc(abs(avg_log2FC)))

# Save to Excel
wb <- createWorkbook()
addWorksheet(wb, "filtered_conserved")
writeData(wb, "filtered_conserved", filteredConserv)
saveWorkbook(wb, paste0(output.dir, "conserved_markers_filtered.xlsx"), overwrite = TRUE)
```


## Saturation analysis

### cellID sampling without reads
This is to look at cellID sampling to ask: why don't we see those 10X only cells also in SALVE?
```{r loading}
input.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/bamsort/split/"
reads_D1 <- read.csv(paste0(input.dir, "D1_up_CI_bamsort_split_inside.csv"))
reads_LTR <- read.csv(paste0(input.dir, "LTR_CI_bamsort_split_inside.csv"))
reads_nef <- read.csv(paste0(input.dir, "nef_CI_bamsort_split_inside.csv"))
reads_tat <- read.csv(paste0(input.dir, "tat_up_CI_bamsort_split_inside.csv"))

reads_total <- bind_rows(reads_D1, reads_LTR, reads_nef, reads_tat) %>%
  group_by(cellID, UMI) %>%
  summarize(reads = sum(reads), .groups = "drop")

molecules_D1 <- reads_D1 %>% select(-reads)
molecules_LTR <- reads_LTR %>% select(-reads)
molecules_nef <- reads_nef %>% select(-reads)
molecules_tat <- reads_tat %>% select(-reads)
molecules_total <- reads_total %>% select(-reads)
```

```{r sampling and plotting}
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/saturation/sample_cellID/"
samples <- list(
  D1 = molecules_D1,
  nef = molecules_nef,
  LTR = molecules_LTR,
  tat = molecules_tat,
  total = molecules_total)

for (sample_name in names(samples)) {
  sample_data <- samples[[sample_name]]
  
  results <- sample_cellID(sample_data)
  summary <- analyze_cellID_sampling(results, title = paste0("cellID Saturation: ", sample_name))
  
  results_file <- paste0(output.dir, sample_name, "_sample_cellID_results.csv")
  summary_file <- paste0(output.dir, sample_name, "_sample_cellID_summary.csv")
  write.csv(results, results_file, row.names = FALSE)
  write.csv(summary, summary_file, row.names = FALSE)
  
  cat("Processed sample:", sample_name, "\n")
}
```

```{r model fitting}
model_results <- fit_models(results, target_coverage = 95)
model_results <- fit_models(results, target_coverage = 99)
model_results <- fit_models(results, target_coverage = 100)
model_results <- fit_models(results, target_coverage = 120)
```

### UMI sampling with reads
Now looking at UMI sampling to get full picture of read saturation
```{r}
output.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/saturation/sample_UMI/"
samples <- list(
  D1 = reads_D1,
  nef = reads_nef,
  LTR = reads_LTR,
  tat = reads_tat,
  total = reads_total)

for (sample_name in names(samples)) {
  sample_data <- samples[[sample_name]]
  
  results <- sample_UMI_weighted(sample_data)
  summary <- analyze_UMI_sampling(results, title = paste0("Weighted UMI Saturation: ", sample_name))
  
  results_file <- paste0(output.dir, sample_name, "_sample_UMI_results.csv")
  summary_file <- paste0(output.dir, sample_name, "_sample_UMI_summary.csv")
  write.csv(results, results_file, row.names = FALSE)
  write.csv(summary, summary_file, row.names = FALSE)
  
  cat("Processed sample:", sample_name, "\n")
}

```

```{r}
model_results <- fit_models(results, target_coverage = 95, coverage_column = "pair_coverage")
model_results <- fit_models(results, target_coverage = 98.9, coverage_column = "pair_coverage")
model_results <- fit_models(results, target_coverage = 100, coverage_column = "pair_coverage")
model_results <- fit_models(results, target_coverage = 120)
```

### SALVE Summary: mac239 vs Mmul_10
```{r loading}
input.dir <- "/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/bamsort/split/"
reads_summary <- read.csv("/projects/b1042/GoyalLab/egrody/extractedData/EGS013/SALVE/bamsort/split/all_samples_summary.txt", header = TRUE)

sample_names <- reads_summary$Sample
df_numeric <- reads_summary[, -which(names(reads_summary) == "Sample")]
df_transposed <- as.data.frame(t(df_numeric))
colnames(df_transposed) <- sample_names
rownames(df_transposed) <- c("Inside_Rows", "Inside_Total_Reads", "Outside_Rows", "Outside_Total_Reads")
df_transposed <- rbind(df_transposed, Inside_Fraction = round(df_transposed["Inside_Total_Reads",] / df_transposed["Outside_Total_Reads",], 2), Avg_Inside_Reads = round(df_transposed["Inside_Total_Reads",] / df_transposed["Inside_Rows",], 2))

```
